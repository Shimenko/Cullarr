<% settings = @effective_settings %>
<% setting_value = ->(key) { settings.fetch(key).fetch(:value) } %>
<% boolean = ActiveModel::Type::Boolean.new %>
<% bool_setting = ->(key) { boolean.cast(setting_value.call(key)) } %>

<section class="space-y-8">
  <%= render Ui::PanelComponent.new(
    title: "Settings",
    subtitle: "Runtime behavior settings are DB-managed. Secrets and destructive toggles stay env-managed.",
    padding: :lg
  ) do %>
    <%= form_with url: settings_path, method: :patch, class: "grid gap-4 md:grid-cols-2" do %>
      <%= render Ui::InputComponent.new(
        name: "settings[sync_interval_minutes]",
        label: "Sync Interval (minutes)",
        value: setting_value.call("sync_interval_minutes"),
        type: :number,
        min: 1,
        max: 1440,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[sensitive_action_reauthentication_window_minutes]",
        label: "Sensitive Action Re-auth Window (minutes)",
        value: setting_value.call("sensitive_action_reauthentication_window_minutes"),
        type: :number,
        min: 1,
        max: 1440,
        autocomplete: "off"
      ) %>

      <%= render Ui::SelectComponent.new(
        name: "settings[watched_mode]",
        label: "Watched Mode",
        options: [ [ "Play count", "play_count" ], [ "Percent watched", "percent" ] ],
        selected: setting_value.call("watched_mode")
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[watched_percent_threshold]",
        label: "Watched Percent Threshold",
        value: setting_value.call("watched_percent_threshold"),
        type: :number,
        min: 1,
        max: 100,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[in_progress_min_offset_ms]",
        label: "In-Progress Min Offset (ms)",
        value: setting_value.call("in_progress_min_offset_ms"),
        type: :number,
        min: 1,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[culled_tag_name]",
        label: "Culled Tag Name",
        value: setting_value.call("culled_tag_name"),
        autocomplete: "off"
      ) %>

      <%= render Ui::SelectComponent.new(
        name: "settings[compatibility_mode_default]",
        label: "Default Compatibility Mode",
        options: [ [ "Strict latest", "strict_latest" ], [ "Warn only read-only", "warn_only_read_only" ] ],
        selected: setting_value.call("compatibility_mode_default")
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[retention_sync_runs_days]",
        label: "Retention: Sync Runs (days)",
        value: setting_value.call("retention_sync_runs_days"),
        type: :number,
        min: 1,
        max: 3650,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[retention_deletion_runs_days]",
        label: "Retention: Deletion Runs (days)",
        value: setting_value.call("retention_deletion_runs_days"),
        type: :number,
        min: 1,
        max: 3650,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[retention_audit_events_days]",
        label: "Retention: Audit Events (days, 0 = keep forever)",
        value: setting_value.call("retention_audit_events_days"),
        type: :number,
        min: 0,
        max: 36_500,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[image_proxy_timeout_seconds]",
        label: "Image Proxy Timeout (seconds)",
        value: setting_value.call("image_proxy_timeout_seconds"),
        type: :number,
        min: 1,
        max: 120,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "settings[image_proxy_max_bytes]",
        label: "Image Proxy Max Bytes",
        value: setting_value.call("image_proxy_max_bytes"),
        type: :number,
        min: 65_536,
        max: 52_428_800,
        autocomplete: "off"
      ) %>

      <div class="md:col-span-2 grid gap-3 rounded-lg border ui-border p-4">
        <%= render Ui::SwitchComponent.new(
          name: "settings[sync_enabled]",
          label: "Sync Enabled",
          checked: bool_setting.call("sync_enabled")
        ) %>

        <%= render Ui::SwitchComponent.new(
          name: "settings[image_cache_enabled]",
          label: "Image Cache Enabled",
          checked: bool_setting.call("image_cache_enabled")
        ) %>

        <%= render Ui::CheckboxComponent.new(
          name: "settings[unmonitor_parent_on_partial_version_delete]",
          label: "Unmonitor Parent on Partial Version Delete (advanced)",
          checked: bool_setting.call("unmonitor_parent_on_partial_version_delete")
        ) %>
      </div>

      <div class="md:col-span-2">
        <%= render Ui::InlineAlertComponent.new(
          kind: :warning,
          title: "Destructive confirmation",
          message: "Setting audit retention to 0 requires explicit confirmation."
        ) %>

        <div class="mt-3">
          <%= render Ui::CheckboxComponent.new(
            name: "destructive_confirmations[retention_audit_events_days_zero]",
            label: "I confirm intentionally setting audit retention to 0",
            checked: false
          ) %>
        </div>
      </div>

      <div class="md:col-span-2">
        <%= render Ui::ButtonComponent.new(label: "Save Settings", variant: :primary, type: :submit) %>
      </div>
    <% end %>
  <% end %>

  <%= render Ui::PanelComponent.new(
    title: "Mapping Health",
    subtitle: "Canonical path mapping quality and overlap risk indicators from the latest local index state.",
    padding: :lg
  ) do %>
    <dl class="grid gap-3 md:grid-cols-3">
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Enabled Path Mappings</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:enabled_path_mappings) %></dd>
      </div>
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Media Files Indexed</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:media_files_total) %></dd>
      </div>
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Canonicalized File Paths</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:media_files_with_canonical_path) %></dd>
      </div>
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Ambiguous Canonical Paths</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:ambiguous_path_count) %></dd>
      </div>
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Ambiguous Media Files</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:ambiguous_media_file_count) %></dd>
      </div>
      <div class="rounded-lg border ui-border p-3 ui-copy">
        <dt class="ui-help">Integrations Without Path Mappings</dt>
        <dd class="ui-text-primary font-semibold"><%= @mapping_health_metrics.fetch(:integrations_without_path_mappings) %></dd>
      </div>
    </dl>
  <% end %>

  <%= render Ui::PanelComponent.new(
    title: "Security",
    subtitle: "Re-authenticate before sensitive actions and rotate password here. Current unlock window: #{setting_value.call("sensitive_action_reauthentication_window_minutes")} minutes.",
    padding: :lg
  ) do %>
    <div class="grid gap-6 md:grid-cols-2">
      <%= form_with url: re_authenticate_security_path, method: :post, class: "space-y-3" do %>
        <h4 class="ui-copy ui-text-primary font-semibold">Re-authenticate</h4>

        <%= render Ui::InputComponent.new(
          name: "password",
          label: "Password",
          type: :password,
          required: true,
          autocomplete: "current-password"
        ) %>

        <%= render Ui::ButtonComponent.new(label: "Re-authenticate", variant: :secondary, type: :submit) %>
      <% end %>

      <%= form_with url: update_password_security_path, method: :patch, scope: :password, class: "space-y-3" do %>
        <h4 class="ui-copy ui-text-primary font-semibold">Change Password</h4>

        <%= render Ui::InputComponent.new(
          name: "password[current_password]",
          label: "Current Password",
          type: :password,
          required: true,
          autocomplete: "current-password"
        ) %>

        <%= render Ui::InputComponent.new(
          name: "password[password]",
          label: "New Password",
          type: :password,
          required: true,
          autocomplete: "new-password"
        ) %>

        <%= render Ui::InputComponent.new(
          name: "password[password_confirmation]",
          label: "Confirm New Password",
          type: :password,
          required: true,
          autocomplete: "new-password"
        ) %>

        <%= render Ui::ButtonComponent.new(label: "Update Password", variant: :secondary, type: :submit) %>
      <% end %>
    </div>
  <% end %>

  <%= render Ui::PanelComponent.new(
    title: "Integrations",
    subtitle: "Configure Sonarr, Radarr, and Tautulli endpoints and test compatibility. Integration host/network allowlists are env-managed through CULLARR_ALLOWED_INTEGRATION_HOSTS and CULLARR_ALLOWED_INTEGRATION_NETWORK_RANGES; host patterns support wildcards; when unset, URL validation is permissive.",
    padding: :lg
  ) do %>
    <% default_integration_kind = Integration.kinds.keys.first %>
    <%= form_with url: integrations_path, method: :post, scope: :integration, class: "grid gap-3 md:grid-cols-3", data: { controller: "integration-kind-tuners" } do %>
      <div data-integration-kind-tuners-target="kindField" data-action="change->integration-kind-tuners#kindChanged">
        <%= render Ui::SelectComponent.new(
          name: "integration[kind]",
          label: "Kind",
          options: Integration.kinds.keys,
          selected: default_integration_kind
        ) %>
      </div>

      <%= render Ui::InputComponent.new(
        name: "integration[name]",
        label: "Name",
        required: true,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "integration[base_url]",
        label: "Base URL",
        required: true,
        placeholder: "https://sonarr.local",
        type: :url,
        autocomplete: "url"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "integration[api_key]",
        label: "API Key",
        type: :password,
        required: true,
        autocomplete: "off"
      ) %>

      <%= render Ui::SelectComponent.new(
        name: "integration[settings][compatibility_mode]",
        label: "Compatibility Mode",
        options: [ [ "Strict latest", "strict_latest" ], [ "Warn only read-only", "warn_only_read_only" ] ],
        selected: "strict_latest"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "integration[settings][request_timeout_seconds]",
        label: "Request Timeout (seconds)",
        value: 15,
        type: :number,
        min: 1,
        max: 120,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "integration[settings][retry_max_attempts]",
        label: "Retry Attempts",
        value: 5,
        type: :number,
        min: 1,
        max: 10,
        autocomplete: "off"
      ) %>

      <%= tag.div(
        data: {
          integration_kind_tuners_target: "group",
          kind: "sonarr"
        },
        class: ("hidden" unless default_integration_kind == "sonarr")
      ) do %>
        <%= render Ui::InputComponent.new(
          name: "integration[settings][sonarr_fetch_workers]",
          label: "Sonarr Fetch Workers",
          value: 4,
          type: :number,
          min: 1,
          max: 8,
          autocomplete: "off",
          disabled: default_integration_kind != "sonarr"
        ) %>
      <% end %>

      <%= tag.div(
        data: {
          integration_kind_tuners_target: "group",
          kind: "radarr"
        },
        class: ("hidden" unless default_integration_kind == "radarr")
      ) do %>
        <%= render Ui::InputComponent.new(
          name: "integration[settings][radarr_moviefile_fetch_workers]",
          label: "Radarr MovieFile Workers",
          value: 4,
          type: :number,
          min: 1,
          max: 8,
          autocomplete: "off",
          disabled: default_integration_kind != "radarr"
        ) %>
      <% end %>

      <%= tag.div(
        data: {
          integration_kind_tuners_target: "group",
          kind: "tautulli"
        },
        class: ("hidden" unless default_integration_kind == "tautulli")
      ) do %>
        <%= render Ui::InputComponent.new(
          name: "integration[settings][tautulli_history_page_size]",
          label: "Tautulli History Page Size",
          value: 500,
          type: :number,
          min: 50,
          max: 5000,
          autocomplete: "off",
          disabled: default_integration_kind != "tautulli"
        ) %>
      <% end %>

      <div class="pt-7">
        <%= render Ui::CheckboxComponent.new(name: "integration[verify_ssl]", label: "Verify SSL", checked: true) %>
      </div>

      <div class="md:col-span-3">
        <%= render Ui::ButtonComponent.new(label: "Add Integration", variant: :primary, type: :submit) %>
      </div>
    <% end %>

    <div class="mt-6 space-y-4">
      <% @integrations.each do |integration| %>
        <%= render Ui::PanelComponent.new(padding: :md, class_name: "ui-hover-row") do %>
          <div class="flex items-center justify-between gap-2">
            <h4 class="ui-copy ui-text-primary font-semibold"><%= integration.name %> (<%= integration.kind %>)</h4>
            <%= render Ui::ChipComponent.new(label: integration.status, kind: :instance) %>
          </div>

          <p class="ui-help mt-1">API key saved: <%= integration.api_key_present? ? "yes" : "no" %></p>

          <%= form_with url: integration_path(integration), method: :patch, scope: :integration, class: "mt-3 grid gap-2 md:grid-cols-3" do %>
            <%= render Ui::InputComponent.new(
              name: "integration[name]",
              label: "Name",
              value: integration.name,
              autocomplete: "off"
            ) %>

            <%= render Ui::InputComponent.new(
              name: "integration[base_url]",
              label: "Base URL",
              value: integration.base_url,
              type: :url,
              autocomplete: "url"
            ) %>

            <%= render Ui::InputComponent.new(
              name: "integration[api_key]",
              label: "API Key",
              type: :password,
              placeholder: "Leave blank to keep existing",
              autocomplete: "off"
            ) %>

            <%= render Ui::SelectComponent.new(
              name: "integration[settings][compatibility_mode]",
              label: "Compatibility Mode",
              options: [ [ "Strict latest", "strict_latest" ], [ "Warn only read-only", "warn_only_read_only" ] ],
              selected: integration.compatibility_mode
            ) %>

            <%= render Ui::InputComponent.new(
              name: "integration[settings][request_timeout_seconds]",
              label: "Request Timeout (seconds)",
              value: integration.request_timeout_seconds,
              type: :number,
              min: 1,
              max: 120,
              autocomplete: "off"
            ) %>

            <%= render Ui::InputComponent.new(
              name: "integration[settings][retry_max_attempts]",
              label: "Retry Attempts",
              value: integration.retry_max_attempts,
              type: :number,
              min: 1,
              max: 10,
              autocomplete: "off"
            ) %>
            <% if integration.sonarr? %>
              <%= render Ui::InputComponent.new(
                name: "integration[settings][sonarr_fetch_workers]",
                label: "Sonarr Fetch Workers",
                value: integration.sonarr_fetch_workers,
                type: :number,
                min: 1,
                max: 8,
                autocomplete: "off"
              ) %>
            <% end %>

            <% if integration.radarr? %>
              <%= render Ui::InputComponent.new(
                name: "integration[settings][radarr_moviefile_fetch_workers]",
                label: "Radarr MovieFile Workers",
                value: integration.radarr_moviefile_fetch_workers,
                type: :number,
                min: 1,
                max: 8,
                autocomplete: "off"
              ) %>
            <% end %>

            <% if integration.tautulli? %>
              <%= render Ui::InputComponent.new(
                name: "integration[settings][tautulli_history_page_size]",
                label: "Tautulli History Page Size",
                value: integration.tautulli_history_page_size,
                type: :number,
                min: 50,
                max: 5000,
                autocomplete: "off"
              ) %>
            <% end %>

            <div class="pt-7">
              <%= render Ui::CheckboxComponent.new(
                name: "integration[verify_ssl]",
                label: "Verify SSL",
                checked: integration.verify_ssl
              ) %>
            </div>

            <div class="pt-7">
              <%= render Ui::ButtonComponent.new(label: "Save", variant: :secondary, type: :submit) %>
            </div>
          <% end %>

          <div class="mt-2 flex flex-wrap gap-2">
            <%= form_with url: check_integration_path(integration), method: :post do %>
              <%= render Ui::ButtonComponent.new(label: "Check", variant: :secondary, type: :submit) %>
            <% end %>

            <%= form_with url: integration_path(integration), method: :delete do %>
              <%= render Ui::ButtonComponent.new(label: "Delete", variant: :danger, type: :submit) %>
            <% end %>
          </div>

          <div class="mt-3 border-t ui-border pt-3">
            <h5 class="ui-copy ui-text-primary font-semibold">Path Mappings</h5>
            <p class="mt-1 ui-help">
              Use mappings when integration mount prefixes differ from local canonical prefixes.
            </p>
            <p class="mt-1 ui-help">
              Root mapping (<code>/</code>) is supported and applies to all absolute paths; prefer explicit prefixes first when possible.
            </p>
            <div class="mt-2 space-y-2">
              <% integration.path_mappings.each do |mapping| %>
                <div class="flex items-center justify-between gap-2 rounded-lg border ui-border px-3 py-2 ui-copy ui-hover-row">
                  <span><%= mapping.from_prefix %> â†’ <%= mapping.to_prefix %></span>
                  <%= form_with url: integration_path_mapping_path(integration, mapping), method: :delete do %>
                    <%= render Ui::ButtonComponent.new(label: "Delete", variant: :secondary, size: :sm, type: :submit) %>
                  <% end %>
                </div>
              <% end %>
            </div>

            <%= form_with url: integration_path_mappings_path(integration), method: :post, scope: :path_mapping, class: "mt-3 grid gap-2 md:grid-cols-3" do %>
              <%= render Ui::InputComponent.new(
                name: "path_mapping[from_prefix]",
                label: "From Prefix",
                placeholder: "/data/tv",
                autocomplete: "off"
              ) %>

              <%= render Ui::InputComponent.new(
                name: "path_mapping[to_prefix]",
                label: "To Prefix",
                placeholder: "/mnt/tv",
                autocomplete: "off"
              ) %>

              <div class="pt-7">
                <%= render Ui::ButtonComponent.new(label: "Add Mapping", variant: :secondary, type: :submit) %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%= render Ui::PanelComponent.new(
    title: "Path Exclusions",
    subtitle: "Excluded prefixes are blocked in candidate and deletion flows.",
    padding: :lg
  ) do %>
    <%= form_with url: path_exclusions_path, method: :post, scope: :path_exclusion, class: "grid gap-2 md:grid-cols-3" do %>
      <%= render Ui::InputComponent.new(
        name: "path_exclusion[name]",
        label: "Name",
        placeholder: "Kids media",
        required: true,
        autocomplete: "off"
      ) %>

      <%= render Ui::InputComponent.new(
        name: "path_exclusion[path_prefix]",
        label: "Path Prefix",
        placeholder: "/media/kids",
        required: true,
        autocomplete: "off"
      ) %>

      <div class="pt-7">
        <%= render Ui::ButtonComponent.new(label: "Add Exclusion", variant: :secondary, type: :submit) %>
      </div>
    <% end %>

    <div class="mt-4 space-y-2">
      <% @path_exclusions.each do |exclusion| %>
        <div class="flex items-center justify-between gap-2 rounded-lg border ui-border px-3 py-2 ui-copy ui-hover-row">
          <span><%= exclusion.name %>: <%= exclusion.path_prefix %></span>
          <%= form_with url: path_exclusion_path(exclusion), method: :delete do %>
            <%= render Ui::ButtonComponent.new(label: "Delete", variant: :secondary, size: :sm, type: :submit) %>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</section>
